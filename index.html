<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Последний Контроль</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <style>
    :root {
      --bg: var(--tg-theme-bg-color, #0d1117);
      --text: var(--tg-theme-text-color, #e6edf3);
      --secondary: var(--tg-theme-secondary-bg-color, #161b22);
      --button: var(--tg-theme-button-color, #238636);
      --button-text: var(--tg-theme-button-text-color, #ffffff);
      --accent: var(--tg-theme-accent-text-color, #58a6ff);
      --card: rgba(22,27,34,0.82);
      --border: rgba(240,246,252,0.16);
      --blur: blur(16px);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }

    #app { height: 100%; display: flex; flex-direction: column; }

    .screen {
      display: none;
      flex-direction: column;
      height: 100%;
      padding: 16px 14px;
      overflow-y: auto;
      background: linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.75));
      backdrop-filter: var(--blur);
    }

    .active { display: flex; }

    .header {
      font-size: 1.55rem;
      font-weight: 700;
      text-align: center;
      padding: 16px 20px;
      background: rgba(22,27,34,0.88);
      border-radius: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 12px 48px rgba(0,0,0,0.6);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header span { color: var(--accent); }

    .card {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      margin: 16px 0;
      border: 1px solid var(--border);
      box-shadow: 0 12px 48px rgba(0,0,0,0.55);
      backdrop-filter: var(--blur);
      animation: fadeInUp 0.5s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity:0; transform:translateY(20px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .tool-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin: 24px 0;
    }

    .tool-card {
      text-align: center;
      padding: 20px 16px;
      border-radius: 20px;
      background: linear-gradient(145deg, rgba(30,35,45,0.94), rgba(15,20,30,0.94));
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.28s ease;
    }

    .tool-card:hover, .tool-card:active {
      transform: translateY(-6px);
      box-shadow: 0 20px 64px rgba(0,0,0,0.7);
    }

    .tool-card img {
      width: 68px;
      height: 68px;
      margin-bottom: 12px;
      filter: drop-shadow(0 6px 12px rgba(0,0,0,0.8));
    }

    .tool-card .name { font-size: 1.18rem; font-weight: 600; margin-bottom: 8px; }
    .tool-card .price { color: #ffd700; font-weight: 700; font-size: 1.1rem; }

    .btn {
      padding: 16px 32px;
      border: none;
      border-radius: 16px;
      font-size: 1.18rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.22s ease;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }

    .btn:active { transform: scale(0.96); }

    .btn-green  { background: linear-gradient(145deg, #238636, #2ea44f); color: white; }
    .btn-yellow { background: linear-gradient(145deg, #daaa3f, #f1c232); color: #0d1117; }
    .btn-red    { background: linear-gradient(145deg, #c94a4a, #d9534f); color: white; }
    .btn-purple { background: linear-gradient(145deg, #6e5494, #8a63d2); color: white; }

    .portrait {
      width: 100%;
      max-width: 300px;
      border-radius: 24px;
      margin: 0 auto 28px;
      display: block;
      box-shadow: 0 24px 72px rgba(0,0,0,0.85);
      border: 4px solid rgba(255,255,255,0.12);
    }

    .decision-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin: 36px 0 24px;
    }

    .log {
      background: rgba(13,17,23,0.92);
      border-radius: 20px;
      padding: 20px;
      margin: 24px 0;
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
      font-size: 1.05rem;
      line-height: 1.6;
    }

    .symptom {
      padding: 14px 18px;
      margin: 12px 0;
      border-radius: 16px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 6px 24px rgba(0,0,0,0.6);
      animation: fadeInUp 0.5s ease-out;
    }

    .green  { background: rgba(46,125,50,0.85); color: white; }
    .yellow { background: rgba(245,184,0,0.85); color: #0d1117; }
    .red    { background: rgba(200,50,50,0.85); color: white; }

    .menu {
      position: absolute;
      top: 70px;
      right: 16px;
      background: rgba(22,27,34,0.97);
      border-radius: 20px;
      padding: 20px;
      flex-direction: column;
      gap: 16px;
      z-index: 100;
      border: 1px solid var(--border);
      box-shadow: 0 20px 80px rgba(0,0,0,0.85);
      min-width: 260px;
    }

    .menu button {
      width: 100%;
      padding: 16px 20px;
      background: rgba(40,45,55,0.9);
      border: none;
      border-radius: 16px;
      color: var(--text);
      font-size: 1.15rem;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .progress-bar {
      height: 14px;
      background: rgba(40,45,55,0.9);
      border-radius: 7px;
      overflow: hidden;
      margin: 20px 0;
      box-shadow: inset 0 3px 10px rgba(0,0,0,0.7);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #238636, #58a6ff, #d32f2f);
      transition: width 0.6s ease;
    }
  </style>
</head>
<body>

<div id="app">

  <!-- Главный экран -->
  <div id="main" class="screen active">
    <div class="header">
      <span>День <b id="day">1</b></span>
      <span>RP <b id="rp">0</b></span>
      <span>Заражение <b id="inf">0.0</b>/7</span>
    </div>

    <div class="card" id="daily-stats" style="text-align:center; font-size:1.2rem; font-weight:500;"></div>

    <div style="margin:24px 0;">
      <div class="progress-bar"><div class="progress-fill" id="inf-bar" style="width:0%"></div></div>
    </div>

    <div class="queue" id="queue" style="display:flex; flex-wrap:wrap; gap:16px; justify-content:center; margin:32px 0;"></div>

    <button id="next-person" class="btn btn-green" style="margin:40px auto; width:94%; max-width:420px; font-size:1.25rem; padding:20px;">
      Осмотреть следующего
    </button>

    <button onclick="document.getElementById('menu').classList.toggle('active')" style="position:absolute;top:20px;right:20px;background:rgba(40,45,55,0.85);color:white;border:none;padding:16px;border-radius:50%;font-size:1.4rem;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
      <i class="fas fa-bars"></i>
    </button>

    <div id="menu" class="menu">
      <button onclick="show('profile')"><i class="fas fa-user-circle fa-lg"></i> Профиль</button>
      <button onclick="show('upgrades')"><i class="fas fa-tools fa-lg"></i> Прокачка</button>
      <button onclick="resetGame()"><i class="fas fa-sync-alt fa-lg"></i> Сбросить игру</button>
    </div>
  </div>

  <!-- Осмотр -->
  <div id="inspect" class="screen">
    <div class="header">Осмотр №<span id="pid"></span></div>

    <img id="portrait" class="portrait" src="" alt="">

    <div id="desc" style="text-align:center; font-size:1.2rem; margin:24px 0; line-height:1.5; opacity:0.94;"></div>

    <div class="tool-grid" id="tools"></div>

    <div class="log" id="log"></div>

    <div class="decision-grid">
      <button class="btn btn-green"     onclick="decide('SAFE')">SAFE</button>
      <button class="btn btn-yellow" onclick="decide('QUARANTINE')">КАРАНТИН</button>
      <button class="btn btn-red"    onclick="decide('LIQUIDATION')">ЛИКВИДАЦИЯ</button>
      <button class="btn btn-purple" id="btn-lab" onclick="decide('LAB')">LAB</button>
    </div>

    <button onclick="show('main')" style="margin:32px auto; background:rgba(40,45,55,0.85); color:white; border:none; padding:16px 48px; border-radius:20px; font-size:1.15rem; width:94%; max-width:420px;">
      ← Назад
    </button>
  </div>

  <!-- Прокачка -->
  <div id="upgrades" class="screen">
    <div class="header">Прокачка инструментов</div>
    <div class="tool-grid" id="upgrade-list"></div>
    <button onclick="show('main')" class="btn" style="margin:36px auto; background:rgba(40,45,55,0.85); color:white; width:94%; max-width:420px;">
      Назад
    </button>
  </div>

  <!-- Профиль -->
  <div id="profile" class="screen">
    <div class="header">Профиль</div>
    <div class="card" style="text-align:center; font-size:1.25rem; line-height:1.7;">
      <p style="margin:20px 0;">Лучший день: <b id="bestday">—</b></p>
      <p style="margin:20px 0;">Точность: <b id="acc">—</b>%</p>
      <p style="margin:20px 0;">Осмотрено: <b id="total">0</b></p>
    </div>
    <button onclick="show('main')" class="btn" style="margin:36px auto; background:rgba(40,45,55,0.85); color:white; width:94%; max-width:420px;">
      Назад
    </button>
  </div>

</div>

<script>
// Telegram
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
}

// State (можно расширять дальше)
let state = {
  day: 1,
  rp: 0,
  inf: 0,
  tools: ['Flashlight'],
  queue: [],
  person: null,
  found: [],
  stats: { s:0, q:0, l:0, lab:0 },
  total: 0,
  correct: 0,
  bestDay: 0
};

// Tools
const TOOLS = [
  { n: 'Flashlight',        t: 'Фонарик',          icon: 'https://img.icons8.com/ios-filled/100/ffffff/flashlight.png',        cost: 0   },
  { n: 'Thermopulsometer',  t: 'Термопульс',       icon: 'https://img.icons8.com/ios-filled/100/ffffff/thermometer.png',      cost: 400 },
  { n: 'ReflexHammer',      t: 'Рефлексы',         icon: 'https://img.icons8.com/ios-filled/100/ffffff/hammer.png',           cost: 600 },
  { n: 'Stethoscope',       t: 'Стетоскоп',        icon: 'https://img.icons8.com/ios-filled/100/ffffff/stethoscope.png',      cost: 800 },
  { n: 'UVScanner',         t: 'UV-сканер',        icon: 'https://img.icons8.com/ios-filled/100/ffffff/uv-light.png',         cost: 1200},
  { n: 'XRay',              t: 'Рентген',          icon: 'https://img.icons8.com/ios-filled/100/ffffff/x-ray.png',            cost: 1800},
  { n: 'SyringeAnalyzer',   t: 'Анализ крови',     icon: 'https://img.icons8.com/ios-filled/100/ffffff/syringe.png',          cost: 2800}
];

// Portraits (можно добавить больше)
const PORTRAITS = [
  'https://images.unsplash.com/photo-1603733265789-4d049460a6f3?w=400',
  'https://images.unsplash.com/photo-1540979388789-7cee28a1cdc9?w=400',
  'https://images.unsplash.com/photo-1563299796-17596ed6b017?w=400',
  'https://images.unsplash.com/photo-1544724569-5f546fd6f2b5?w=400'
];

// Load / Save
function load() {
  const s = localStorage.getItem('lastcontrol_pro');
  if (s) Object.assign(state, JSON.parse(s));
  renderAll();
}

function save() {
  localStorage.setItem('lastcontrol_pro', JSON.stringify(state));
}

function resetGame() {
  state = { day:1, rp:0, inf:0, tools:['Flashlight'], queue:[], person:null, found:[], stats:{s:0,q:0,l:0,lab:0}, total:0, correct:0, bestDay:0 };
  save();
  startDay();
  show('main');
}

// Day
function startDay() {
  const cnt = 8 + Math.floor(Math.random() * 12);
  state.queue = Array.from({length: cnt}, (_, i) => ({ id: i+1 }));
  renderQueue();
  renderAll();
}

function renderQueue() {
  const q = document.getElementById('queue');
  q.innerHTML = '';
  state.queue.slice(0,6).forEach(p => {
    const div = document.createElement('div');
    div.style.cssText = 'width:68px;height:68px;background:#1f2937;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.4rem;border:3px solid #374151;box-shadow:0 4px 12px rgba(0,0,0,0.5);';
    div.textContent = p.id;
    q.appendChild(div);
  });
}

function renderAll() {
  document.getElementById('day').textContent = state.day;
  document.getElementById('rp').textContent = state.rp;
  document.getElementById('inf').textContent = state.inf.toFixed(1);
  document.getElementById('daily-stats').innerHTML = `SAFE: ${state.stats.s}  КАР: ${state.stats.q}  ЛИК: ${state.stats.l}  LAB: ${state.stats.lab}`;
  document.getElementById('inf-bar').style.width = Math.min(state.inf / 7 * 100, 100) + '%';
}

// Inspection
document.getElementById('next-person').onclick = () => {
  if (!state.queue.length) return;
  state.person = state.queue.shift();
  state.found = [];
  document.getElementById('pid').textContent = state.person.id;
  document.getElementById('desc').textContent = 'Человек выглядит подозрительно...';
  document.getElementById('portrait').src = PORTRAITS[Math.floor(Math.random() * PORTRAITS.length)];
  document.getElementById('log').innerHTML = '<div class="symptom green">Начните осмотр инструментами</div>';
  renderTools();
  show('inspect');
};

function renderTools() {
  const container = document.getElementById('tools');
  container.innerHTML = '';
  TOOLS.forEach(tool => {
    if (state.tools.includes(tool.n)) {
      const card = document.createElement('div');
      card.className = 'tool-card';
      card.innerHTML = `
        <img src="${tool.icon}" alt="${tool.t}">
        <div class="name">${tool.t}</div>
      `;
      card.onclick = () => {
        const log = document.getElementById('log');
        log.innerHTML += `<div class="symptom yellow">Осмотр ${tool.t.toLowerCase()}...</div>`;
        log.scrollTop = log.scrollHeight;
      };
      container.appendChild(card);
    }
  });
}

function decide(choice) {
  const log = document.getElementById('log');
  log.innerHTML += `<div class="symptom ${choice === 'SAFE' ? 'green' : choice === 'QUARANTINE' ? 'yellow' : choice === 'LIQUIDATION' ? 'red' : 'purple'}">
    Решение: ${choice}
  </div>`;
  log.scrollTop = log.scrollHeight;

  state.stats[choice[0].toLowerCase()]++;
  show('main');
  save();
  renderAll();
}

// Upgrades
function renderUpgrades() {
  const container = document.getElementById('upgrade-list');
  container.innerHTML = '';
  TOOLS.forEach(tool => {
    if (!state.tools.includes(tool.n) && tool.cost) {
      const card = document.createElement('div');
      card.className = 'tool-card';
      card.innerHTML = `
        <img src="${tool.icon}" alt="${tool.t}">
        <div class="name">${tool.t}</div>
        <div class="price">${tool.cost} RP</div>
        <button class="btn btn-green" ${state.rp < tool.cost ? 'disabled' : ''} onclick="buyTool('${tool.n}')">
          Купить
        </button>
      `;
      container.appendChild(card);
    }
  });
}

function buyTool(name) {
  const tool = TOOLS.find(t => t.n === name);
  if (state.rp >= tool.cost) {
    state.rp -= tool.cost;
    state.tools.push(name);
    save();
    renderUpgrades();
    renderAll();
  }
}

// Navigation
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'upgrades') renderUpgrades();
}

// Init
load();
startDay();
renderAll();
</script>
</body>
</html>
