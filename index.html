<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Последний Контроль</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --tg-bg: var(--tg-theme-bg-color, #0d1117);
      --tg-text: var(--tg-theme-text-color, #c9d1d9);
      --tg-secondary: var(--tg-theme-secondary-bg-color, #161b22);
      --tg-button: var(--tg-theme-button-color, #238636);
      --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
      --tg-accent: var(--tg-theme-accent-text-color, #58a6ff);
      --card-bg: rgba(22, 27, 34, 0.75);
      --blur: blur(12px);
      --border: rgba(240, 246, 252, 0.12);
      --green: #238636;
      --yellow: #daaa3f;
      --red: #c94a4a;
      --purple: #6e5494;
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-bg);
      color: var(--tg-text);
      min-height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }

    #app {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .screen {
      display: none;
      flex-direction: column;
      height: 100%;
      padding: 16px 12px;
      overflow-y: auto;
      background: rgba(13, 17, 23, 0.6);
      backdrop-filter: var(--blur);
    }

    .active { display: flex; }

    .header {
      font-size: 1.45rem;
      font-weight: 700;
      text-align: center;
      padding: 14px 16px;
      background: rgba(22, 27, 34, 0.8);
      border-radius: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }

    .card {
      background: var(--card-bg);
      backdrop-filter: var(--blur);
      border-radius: 16px;
      padding: 16px 18px;
      margin: 12px 0;
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px rgba(0,0,0,0.45);
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }

    .card:active { transform: scale(0.98); }

    .tool-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(148px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }

    .tool-card {
      text-align: center;
      padding: 18px 12px;
      border-radius: 16px;
      background: linear-gradient(145deg, rgba(30,35,45,0.9), rgba(15,20,30,0.9));
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.22s ease;
    }

    .tool-card:active { transform: scale(0.96); box-shadow: 0 12px 40px rgba(0,0,0,0.6); }

    .tool-card img {
      width: 56px;
      height: 56px;
      margin-bottom: 10px;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6));
    }

    .tool-card .name { font-size: 1.05rem; font-weight: 600; margin-bottom: 6px; }
    .tool-card .price { color: #ffd700; font-weight: 700; }

    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 12px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.18s;
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    .btn:active { transform: scale(0.97); }

    .btn-green  { background: linear-gradient(145deg, var(--green), #2ea44f); color: white; }
    .btn-yellow { background: linear-gradient(145deg, var(--yellow), #f1c232); color: #0d1117; }
    .btn-red    { background: linear-gradient(145deg, var(--red), #d9534f); color: white; }
    .btn-purple { background: linear-gradient(145deg, var(--purple), #8a63d2); color: white; }

    .portrait {
      width: 100%;
      max-width: 260px;
      height: auto;
      border-radius: 20px;
      margin: 0 auto 20px;
      display: block;
      box-shadow: 0 16px 48px rgba(0,0,0,0.7);
      border: 3px solid rgba(255,255,255,0.08);
    }

    .decision-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin: 28px 0 16px;
    }

    .log {
      background: rgba(13,17,23,0.85);
      border-radius: 16px;
      padding: 16px;
      margin: 20px 0;
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--border);
      font-size: 0.98rem;
      line-height: 1.5;
    }

    .symptom {
      padding: 12px 16px;
      margin: 10px 0;
      border-radius: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }

    .green  { background: rgba(46,125,50,0.75); color: white; }
    .yellow { background: rgba(245,184,0,0.75); color: #0d1117; }
    .red    { background: rgba(200,50,50,0.75); color: white; animation: pulse 1.8s infinite; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%      { opacity: 0.88; }
    }

    .menu {
      position: absolute;
      top: 64px;
      right: 16px;
      background: rgba(22,27,34,0.95);
      border-radius: 16px;
      padding: 16px;
      flex-direction: column;
      gap: 12px;
      z-index: 100;
      border: 1px solid var(--border);
      box-shadow: 0 12px 48px rgba(0,0,0,0.7);
      min-width: 220px;
    }

    .menu button {
      width: 100%;
      padding: 14px;
      background: rgba(40,45,55,0.8);
      border: none;
      border-radius: 12px;
      color: var(--tg-text);
      font-size: 1.05rem;
      text-align: left;
    }

    .progress-bar {
      height: 8px;
      background: rgba(40,45,55,0.8);
      border-radius: 4px;
      overflow: hidden;
      margin: 12px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #238636, #58a6ff);
      transition: width 0.4s ease;
    }
  </style>
</head>
<body>

<div id="app">

  <!-- Главный экран -->
  <div id="main" class="screen active">
    <div class="header">
      День <span id="day">1</span>  RP <span id="rp">0</span>  Заражение <span id="inf">0.0</span>/7
    </div>

    <div class="card" id="daily-stats" style="text-align:center; font-size:1.1rem; font-weight:500;"></div>

    <div style="margin:20px 0; text-align:center;">
      <div class="progress-bar"><div class="progress-fill" id="inf-bar" style="width:0%"></div></div>
    </div>

    <div class="queue" id="queue" style="display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin:24px 0;"></div>

    <button id="next-person" class="btn btn-green" style="margin:28px auto; width:90%; max-width:380px; font-size:1.15rem;">
      Осмотреть следующего
    </button>

    <button class="menu-btn" onclick="document.getElementById('menu').classList.toggle('active')">
      <i class="fas fa-bars"></i> Меню
    </button>

    <div id="menu" class="menu">
      <button onclick="show('profile')"><i class="fas fa-user"></i> Профиль</button>
      <button onclick="show('upgrades')"><i class="fas fa-tools"></i> Прокачка</button>
      <button onclick="resetGame()"><i class="fas fa-redo"></i> Сбросить игру</button>
    </div>
  </div>

  <!-- Экран осмотра -->
  <div id="inspect" class="screen">
    <div class="header">Осмотр №<span id="pid"></span></div>

    <img id="portrait" class="portrait" src="" alt="">

    <div id="desc" style="text-align:center; font-size:1.1rem; margin:16px 0; opacity:0.9; line-height:1.4;"></div>

    <div class="tool-grid" id="tools"></div>

    <div class="log" id="log"></div>

    <div class="decision-grid">
      <button class="btn btn-green"     onclick="decide('SAFE')">SAFE</button>
      <button class="btn btn-yellow" onclick="decide('QUARANTINE')">КАРАНТИН</button>
      <button class="btn btn-red"    onclick="decide('LIQUIDATION')">ЛИКВИДАЦИЯ</button>
      <button class="btn btn-purple" id="btn-lab" onclick="decide('LAB')">LAB</button>
    </div>

    <button onclick="show('main')" style="margin:24px auto; background:rgba(40,45,55,0.8); color:white; border:none; padding:14px 32px; border-radius:12px; font-size:1.05rem; width:90%; max-width:360px;">
      ← Назад
    </button>
  </div>

  <!-- Прокачка -->
  <div id="upgrades" class="screen">
    <div class="header">Прокачка инструментов</div>
    <div class="tool-grid" id="upgrade-list"></div>
    <button onclick="show('main')" class="btn" style="margin:28px auto; background:rgba(40,45,55,0.8); color:white; width:90%; max-width:360px;">
      Назад
    </button>
  </div>

  <!-- Профиль -->
  <div id="profile" class="screen">
    <div class="header">Профиль</div>
    <div class="card" style="text-align:center; font-size:1.15rem;">
      <p style="margin:12px 0;">Лучший день: <b id="bestday">—</b></p>
      <p style="margin:12px 0;">Точность: <b id="acc">—</b>%</p>
      <p style="margin:12px 0;">Осмотрено: <b id="total">0</b></p>
    </div>
    <button onclick="show('main')" class="btn" style="margin:28px auto; background:rgba(40,45,55,0.8); color:white; width:90%; max-width:360px;">
      Назад
    </button>
  </div>

</div>

<script>
// ──────────────────────────────────────────────
// Основные переменные
// ──────────────────────────────────────────────
const tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
}

let state = {
  day: 1,
  rp: 0,
  inf: 0,
  tools: ['Flashlight'],
  queue: [],
  person: null,
  found: [],
  stats: {s:0,q:0,l:0,lab:0},
  total: 0,
  correct: 0,
  bestDay: 0
};

const TOOLS = [
  {n:'Flashlight', t:'Фонарик',        icon:'https://img.icons8.com/ios-filled/50/ffffff/flashlight.png'},
  {n:'Thermopulsometer', t:'Термопульс', icon:'https://img.icons8.com/ios-filled/50/ffffff/thermometer.png', cost:400},
  {n:'ReflexHammer', t:'Рефлексы',     icon:'https://img.icons8.com/ios-filled/50/ffffff/hammer.png', cost:600},
  {n:'Stethoscope', t:'Стетоскоп',     icon:'https://img.icons8.com/ios-filled/50/ffffff/stethoscope.png', cost:800},
  {n:'UVScanner', t:'UV-сканер',       icon:'https://img.icons8.com/ios-filled/50/ffffff/uv-light.png', cost:1200},
  {n:'XRay', t:'Рентген',              icon:'https://img.icons8.com/ios-filled/50/ffffff/x-ray.png', cost:1800},
  {n:'SyringeAnalyzer', t:'Анализ крови', icon:'https://img.icons8.com/ios-filled/50/ffffff/syringe.png', cost:2800}
];

const PORTRAITS = [
  'https://images.unsplash.com/photo-1603733265789-4d049460a6f3?w=400',
  'https://images.unsplash.com/photo-1540979388789-7cee28a1cdc9?w=400',
  'https://images.unsplash.com/photo-1563299796-17596ed6b017?w=400',
  'https://images.unsplash.com/photo-1544724569-5f546fd6f2b5?w=400'
];

// ──────────────────────────────────────────────
// Загрузка / сохранение
// ──────────────────────────────────────────────
function load() {
  const s = localStorage.getItem('lastcontrol_pro');
  if (s) Object.assign(state, JSON.parse(s));
  renderAll();
}

function save() {
  localStorage.setItem('lastcontrol_pro', JSON.stringify(state));
}

function resetGame() {
  state = { day:1, rp:0, inf:0, tools:['Flashlight'], queue:[], person:null, found:[], stats:{s:0,q:0,l:0,lab:0}, total:0, correct:0, bestDay:0 };
  save();
  startDay();
  show('main');
}

// ──────────────────────────────────────────────
// Логика дня
// ──────────────────────────────────────────────
function startDay() {
  const cnt = 8 + Math.floor(Math.random() * 12);
  state.queue = Array.from({length: cnt}, (_, i) => ({ id: i+1 }));
  renderQueue();
  renderAll();
}

function renderQueue() {
  const q = document.getElementById('queue');
  q.innerHTML = '';
  state.queue.slice(0,6).forEach(p => {
    const div = document.createElement('div');
    div.style.cssText = 'width:60px;height:60px;background:#222;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;border:2px solid #444;';
    div.textContent = p.id;
    q.appendChild(div);
  });
}

function renderAll() {
  document.getElementById('day').textContent = state.day;
  document.getElementById('rp').textContent = state.rp;
  document.getElementById('inf').textContent = state.inf.toFixed(1);
  document.getElementById('daily-stats').innerHTML = `SAFE: ${state.stats.s} | КАР: ${state.stats.q} | ЛИК: ${state.stats.l} | LAB: ${state.stats.lab}`;
  document.getElementById('inf-bar').style.width = Math.min(state.inf / 7 * 100, 100) + '%';
}

// ──────────────────────────────────────────────
// Осмотр
// ──────────────────────────────────────────────
document.getElementById('next-person').onclick = () => {
  if (!state.queue.length) return;
  state.person = state.queue.shift();
  state.found = [];
  document.getElementById('pid').textContent = state.person.id;
  document.getElementById('desc').textContent = 'Человек выглядит подозрительно...';
  document.getElementById('portrait').src = PORTRAITS[Math.floor(Math.random()*PORTRAITS.length)];
  document.getElementById('log').innerHTML = '<div class="symptom green">Начните осмотр</div>';
  renderTools();
  show('inspect');
};

function renderTools() {
  const container = document.getElementById('tools');
  container.innerHTML = '';
  TOOLS.forEach(tool => {
    if (state.tools.includes(tool.n)) {
      const card = document.createElement('div');
      card.className = 'tool-card';
      card.innerHTML = `
        <img src="${tool.icon}" alt="${tool.t}">
        <div class="name">${tool.t}</div>
      `;
      card.onclick = () => {
        const log = document.getElementById('log');
        log.innerHTML += `<div class="symptom yellow">Осмотр ${tool.t.toLowerCase()}...</div>`;
        log.scrollTop = log.scrollHeight;
      };
      container.appendChild(card);
    }
  });
}

function decide(choice) {
  const log = document.getElementById('log');
  log.innerHTML += `<div class="symptom ${choice === 'SAFE' ? 'green' : choice === 'QUARANTINE' ? 'yellow' : choice === 'LIQUIDATION' ? 'red' : 'purple'}">
    Решение: ${choice}
  </div>`;
  log.scrollTop = log.scrollHeight;

  state.stats[choice[0].toLowerCase()]++;
  show('main');
  save();
  renderAll();
}

// ──────────────────────────────────────────────
// Прокачка
// ──────────────────────────────────────────────
function renderUpgrades() {
  const container = document.getElementById('upgrade-list');
  container.innerHTML = '';
  TOOLS.forEach(tool => {
    if (!state.tools.includes(tool.n) && tool.cost) {
      const card = document.createElement('div');
      card.className = 'tool-card';
      card.innerHTML = `
        <img src="${tool.icon}" alt="${tool.t}">
        <div class="name">${tool.t}</div>
        <div class="price">${tool.cost} RP</div>
        <button class="btn btn-green" ${state.rp < tool.cost ? 'disabled' : ''} onclick="buyTool('${tool.n}')">
          Купить
        </button>
      `;
      container.appendChild(card);
    }
  });
}

function buyTool(name) {
  const tool = TOOLS.find(t => t.n === name);
  if (state.rp >= tool.cost) {
    state.rp -= tool.cost;
    state.tools.push(name);
    save();
    renderUpgrades();
    renderAll();
  }
}

// ──────────────────────────────────────────────
// Навигация
// ──────────────────────────────────────────────
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (id === 'upgrades') renderUpgrades();
}

// ──────────────────────────────────────────────
// Старт
// ──────────────────────────────────────────────
load();
startDay();
renderAll();
</script>
</body>
</html>
